<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ops Kontrol (Mobil v18)</title>
  <style>
    :root{
      --bg:#0b0b0b; --card:#151515; --card2:#101010;
      --text:#ffffff; --muted:#bdbdbd; --border:#2d2d2d;
      --accent:#00e0ff; --warn:#ffcc00; --bad:#ff4d4d;
      --shadow: 0 10px 30px rgba(0,0,0,.45); --r:16px;
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .wrap{ max-width: 640px; margin: 0 auto; padding: 14px 14px 120px; }
    .screen{ display:none; }
    .screen.active{ display:block; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom: 12px;
    }
    .title{ font-size: 16px; font-weight: 950; margin:0; letter-spacing:.2px; }
    .sub{ margin-top:6px; font-size:12px; color:var(--muted); display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .pill,.chip,button.pill{
      font-size:12px; color:var(--muted);
      border:1px solid var(--border);
      padding: 6px 10px; border-radius: 999px;
      background: rgba(255,255,255,0.03);
      white-space:nowrap;
    }
    .chip.warn{ color:#fff; border-color: rgba(255,204,0,.55); background: rgba(255,204,0,.12); }
    .chip.bad{ color:#fff; border-color: rgba(255,77,77,.5); background: rgba(255,77,77,.12); }

    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 14px;
      margin-bottom: 12px;
    }
    .card.secondary{ background: var(--card2); }

    label{ display:block; font-size: 13px; color: var(--muted); margin: 0 0 6px; font-weight: 750; }
    .field{ display:flex; flex-direction:column; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .grid3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    @media (max-width:420px){ .grid2,.grid3{ grid-template-columns:1fr; } }

    /* IMPORTANT: Native selects for iOS/Android reliability */
    select, input[type="number"], input[type="text"]{
      width:100%;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 16px; /* avoid iOS zoom */
      outline: none;
    }
    option{ background:#101010; color:#fff; }
    input[readonly]{ opacity:.92; background: rgba(255,255,255,0.04); }
    .hint{ margin-top:8px; color:var(--muted); font-size:12px; line-height:1.25rem; }
    .divider{ height:1px; background: var(--border); margin: 12px 0; opacity:.8; }

    .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 6px; }
    button{
      appearance:none; border:none; cursor:pointer;
      border-radius: 14px; padding: 12px 14px;
      font-size: 14px; font-weight: 900;
      color: var(--text);
      background: rgba(255,255,255,0.08);
      border: 1px solid var(--border);
      min-height: 44px;
      flex: 1 1 auto;
    }
    button:active{ transform: translateY(1px); }
    .btn-primary{ background: linear-gradient(180deg, rgba(0,224,255,.25), rgba(0,224,255,.12)); border-color: rgba(0,224,255,.35); }
    .btn-danger{ background: linear-gradient(180deg, rgba(255,60,60,.22), rgba(255,60,60,.10)); border-color: rgba(255,60,60,.35); }

    .stat{
      display:flex; flex-direction:column; gap:6px;
      padding: 12px; border-radius: 14px;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      min-width: 140px;
    }
    .stat .k{ color: var(--muted); font-size: 12px; font-weight:750; }
    .stat .v{ color: var(--accent); font-size: 18px; font-weight: 950; }
    .stat .v.warn{ color: var(--warn); }

    /* Comp cards */
    .compItem{
      border: 1px solid var(--border);
      border-radius: 16px;
      background: rgba(255,255,255,0.03);
      padding: 12px;
      margin-bottom: 10px;
    }
    .compTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
    .compName{ font-size: 16px; font-weight: 950; }
    .compMini{
      font-size: 12px; color: var(--muted);
      border: 1px solid var(--border);
      padding: 6px 10px; border-radius: 999px;
      background: rgba(255,255,255,0.02);
      white-space:nowrap;
    }
    .miniVal{ font-variant-numeric: tabular-nums; color: var(--accent); font-weight: 950; }
    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width:420px){ .row2{ grid-template-columns:1fr; } }
    .qbtnRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .qbtn{
      padding: 10px 10px; min-height: 40px;
      border-radius: 12px;
      font-size: 13px; font-weight: 950;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      color: var(--text);
      cursor:pointer;
      flex: 1 1 auto;
      max-width: 120px;
    }
    
    .groupGrid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width:420px){ .groupGrid{ grid-template-columns:1fr; } }
    .gStat{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 12px;
      border-radius: 14px;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
    }
    .gStat .k{ color: var(--muted); font-size: 12px; font-weight: 850; }
    .gStat .v{ color: var(--accent); font-size: 16px; font-weight: 950; font-variant-numeric: tabular-nums; }

    .lockNote{
      margin-top:8px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,204,0,.55);
      background: rgba(255,204,0,.10);
      color: #fff;
      font-size: 12px;
      line-height: 1.25rem;
      display:none;
    }
  </style>
</head>
<body>
  <!-- HOME -->
  <section class="screen active" id="home">
    <div class="wrap">
      <div class="card">
        <div class="topbar">
          <div>
            <div class="title">Kontrol Paneli</div>
            <div class="sub">
              <span class="pill" id="clockPill">—</span>
              <span class="pill" id="datePill">—</span>
              <span class="chip" id="statusChip">Hazır</span>
            </div>
          </div>
        </div>

        <div class="hint">HTML dosyasından açınca iOS/Android uyumluluğu için ekranı basit tuttum. Modül seç ve devam et.</div>

        <div class="btns" style="margin-top:14px;">
          <button class="btn-primary" id="goLoad" type="button">✈️ Balance / Ağırlık Kontrol</button>
          <button class="btn-primary" id="goRad" type="button">☢️ Radyoaktif Mesafe</button>
        </div>
      </div>
    </div>
  </section>

  <!-- LOAD -->
  <section class="screen" id="load">
    <div class="wrap">
      <div class="card">
        <div class="topbar">
          <div>
            <div class="title">✈️ Balance Kontrol</div>
            <div class="sub">
              <span class="pill" id="clockPillL">—</span>
              <span class="pill" id="datePillL">—</span>
              <span class="chip" id="statusChipL">Aktif</span>
            </div>
          </div>
          <button id="backFromLoad" type="button">Menü</button>
        </div>

        <div class="grid2">
          <div class="field">
            <label>Uçak Kuyruğu (Tail)</label>
            <input type="text" id="tailNo" placeholder="örn. TC-LGA" autocapitalize="characters" />
          </div>

          <div class="field">
            <label>Crew</label>
            <select id="crewCode">
              <option value="">Seçiniz</option>
              <optgroup label="2/ ...">
                <option>2/0</option><option>2/4</option><option>2/5</option><option>2/6</option>
                <option>2/10</option><option>2/11</option><option>2/12</option><option>2/14</option>
              </optgroup>
              <optgroup label="3/ ...">
                <option>3/0</option><option>3/4</option><option>3/5</option><option>3/6</option>
                <option>3/10</option><option>3/11</option><option>3/12</option><option>3/14</option>
              </optgroup>
            </select>
          </div>
        </div>

        <div class="divider"></div>

        <div class="grid2">
          <div class="field">
            <label>Uçak Tipi</label>
            <select id="aircraft">
              <option value="">Seçiniz</option>
              <option value="B738">B-737 / 800</option>
              <option value="B739">B-737 / 900</option>
              <option value="A319">A-319</option>
              <option value="A320">A-320</option>
              <option value="A321">A-321</option>
              <option value="A330">A-330</option>
              <option value="B787">B-787</option>
              <option value="B777">B-777</option>
              <option value="A350">A-350</option>
              <optgroup label="(Bulk - yük tablosu için)">
                <option value="A319B">A319 Bulk</option>
                <option value="A320B">A320 Bulk</option>
                <option value="A321B">A321 Bulk</option>
              </optgroup>
            </select>
          </div>

          <div class="field">
            <label>Hızlı</label>
            <div class="btns">
              <button class="btn-primary" id="btnSave" type="button">Kaydet</button>
              <button class="btn-danger" id="btnReset" type="button">Sıfırla</button>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="grid2">
          <div class="field">
            <label>Toplam Bagaj (kg)</label>
            <input type="number" id="bagTotalKg" inputmode="numeric" placeholder="örn. 2450" />
          </div>
          <div class="field">
            <label>Bagaj PCS</label>
            <input type="number" id="bagPieces" inputmode="numeric" placeholder="örn. 122" />
          </div>
        </div>

        <div class="grid2" style="margin-top:10px;">
          <div class="field">
            <label>Avg Bagaj (kg) — otomatik</label>
            <input type="text" id="avgBag" readonly placeholder="—" />
            <div class="hint">Toplam Bagaj kg / PCS</div>
          </div>
          <div class="field">
            <label>Meta</label>
            <input type="text" id="metaLine" readonly placeholder="—" />
          </div>
        </div>
      </div>

      <div class="card secondary">
        <div class="grid2">
          <div class="field">
            <label>Su Oranı</label>
            <select id="waterRatio">
              <option value="">Seçiniz</option>
            </select>
            <div class="hint" id="waterHint">Uçak tipi + tail girince seçenekler gelir.</div>
          </div>
          <div class="field">
            <label>Su (Ağırlık / Index)</label>
            <div class="grid2">
              <div class="stat" style="min-width:unset;"><div class="k">Su Ağırlığı</div><div class="v" id="waterWeight">—</div></div>
              <div class="stat" style="min-width:unset;"><div class="k">Su Index</div><div class="v warn" id="waterIndex">—</div></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card secondary">
        <div class="grid2">
          <div class="field">
            <label>Total Fuel (kg)</label>
            <input type="number" id="totalFuel" inputmode="numeric" />
          </div>
          <div class="field">
            <label>Taxi Fuel (kg)</label>
            <input type="number" id="taxiFuel" inputmode="numeric" />
          </div>
        </div>
        <div class="divider"></div>
        <div class="grid3">
          <div class="stat"><div class="k">Total</div><div class="v" id="totalFuelEcho">—</div></div>
          <div class="stat"><div class="k">Remaining</div><div class="v warn" id="remainFuel">—</div></div>
          <div class="stat"><div class="k">Taxi</div><div class="v" id="taxiFuelEcho">—</div></div>
        </div>
      </div>

      <div class="card" id="compCard">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <div style="font-weight:950;">Kompartman Girişi</div>
          <button id="btnClearComps" type="button">Komp Sıfırla</button>
        </div>
        <div class="hint" id="compHint">Uçak tipi seçince açılır. Sadece Bag PCS + Cargo KG gir.</div>
        <div id="groupTotals" style="margin-top:10px; display:none;"></div>
        <div id="compList" style="margin-top:12px; display:none;"></div>

        <div class="divider"></div>

        <div class="stat" style="min-width:unset;">
          <div class="k">Toplam Yük (Bagaj + Kargo)</div>
          <div class="v" id="sumTotal">0.0</div>
        </div>

        <details style="margin-top:10px; background: rgba(255,255,255,0.03); border:1px solid var(--border); border-radius:14px; padding: 10px 12px;">
          <summary style="cursor:pointer; font-weight:900; color: var(--muted);">Toplamlar (detay)</summary>
          <div class="grid2" style="margin-top:10px;">
            <div class="stat" style="min-width:unset;"><div class="k">Toplam Bagaj</div><div class="v" id="sumBag">0.0</div></div>
            <div class="stat" style="min-width:unset;"><div class="k">Toplam Kargo</div><div class="v" id="sumCargo">0.0</div></div>
          </div>
        </details>
      </div>
    </div>
  </section>

  <!-- RADIOACTIVE -->
  <section class="screen" id="rad">
    <div class="wrap">
      <div class="card">
        <div class="topbar">
          <div>
            <div class="title">☢️ Radyoaktif Mesafe</div>
            <div class="sub">
              <span class="pill" id="clockPillR">—</span>
              <span class="pill" id="datePillR">—</span>
              <span class="chip" id="statusChipR">Aktif</span>
            </div>
          </div>
          <button id="backFromRad" type="button">Menü</button>
        </div>

        <div class="grid2">
          <div class="field">
            <label>Uçak Tipi</label>
            <select id="radAircraft">
              <option value="">Seçiniz</option>
              <option value="A319">A319</option>
              <option value="A320">A320</option>
              <option value="A321">A321</option>
              <option value="A330-200">A330-200</option>
              <option value="A330-300">A330-300</option>
              <option value="A350">A350</option>
              <option value="B737-800">B737-800</option>
              <option value="B737-900">B737-900</option>
              <option value="B787">B787</option>
              <option value="B777">B777</option>
            </select>
          </div>

          <div class="field">
            <label>Kompartman</label>
            <select id="radComp">
              <option value="">Seçiniz</option>
            </select>
            <div class="hint" id="radCompHint">Uçak tipini seçince gelir.</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="grid2">
          <div class="field">
            <label>TI değerleri (Sum otomatik)</label>
            <input type="text" id="radTI" inputmode="text" placeholder="örn. 1.5 + 0.3 + 0.2" />
            <div class="hint">“+” / virgül / boşluk kabul.</div>
          </div>
          <div class="field">
            <label>Kutu yüksekliği (cm)</label>
            <input type="number" id="radBoxHcm" inputmode="numeric" placeholder="örn. 42" />
          </div>
        </div>

        <div class="divider"></div>

        <div class="grid2">
          <div class="stat" style="min-width:unset;"><div class="k">Sum TI</div><div class="v" id="radSumTI">—</div></div>
          <div class="stat" style="min-width:unset;"><div class="k">Min Mesafe (m)</div><div class="v" id="radMinM">—</div></div>
          <div class="stat" style="min-width:unset;"><div class="k">Gerekli Toplam (cm)</div><div class="v warn" id="radNeedCm">—</div></div>
          <div class="stat" style="min-width:unset;"><div class="k">Kompartman Yüksekliği (cm)</div><div class="v" id="radCompCm">—</div></div>
        </div>

        <div class="divider"></div>

        <div class="stat" style="min-width:unset;">
          <div class="k">Sonuç</div>
          <div class="v" id="radResult">—</div>
        </div>
        <div class="hint">Kural: (Min Mesafe + Kutu Yüksekliği) ≤ Kompartman Yüksekliği.</div>
      </div>
    </div>
  </section>

<script>
  // ===== util =====
  const $ = (id)=>document.getElementById(id);
  function setChip(id, kind, text){
    const el = $(id);
    if(!el) return;
    el.classList.remove("warn","bad");
    if(kind) el.classList.add(kind);
    el.textContent = text;
  }
  function safeNum(v){
    if(v===null || v===undefined) return null;
    if(v==="") return null;
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }
  function updateClock(){
    const now = new Date();
    const c = "Saat: " + now.toLocaleTimeString("tr-TR", {hour:"2-digit", minute:"2-digit", second:"2-digit"});
    const d = now.toLocaleDateString("tr-TR", {weekday:"long", year:"numeric", month:"2-digit", day:"2-digit"});
    ["clockPill","clockPillL","clockPillR"].forEach(id=>{ const el=$(id); if(el) el.textContent=c; });
    ["datePill","datePillL","datePillR"].forEach(id=>{ const el=$(id); if(el) el.textContent=d; });
  }
  updateClock(); setInterval(updateClock, 1000);

  // ===== NAV (no sticky, no overlays) =====
  function show(name){
    ["home","load","rad"].forEach(s=>$(s).classList.remove("active"));
    $(name).classList.add("active");
  }
  function bindTap(id, fn){
    const el = $(id);
    if(!el) return;
    el.addEventListener("click", fn);
    el.addEventListener("touchstart", fn, {passive:true});
  }
  bindTap("goLoad", ()=>show("load"));
  bindTap("goRad", ()=>show("rad"));
  bindTap("backFromLoad", ()=>show("home"));
  bindTap("backFromRad", ()=>show("home"));

  // ===== LOAD DATA =====
  const aircraftComps = {
    "B737": ["1","2","3","4"],
    "A319": ["11","12","41","42","51"],
    "A320": ["11","12","13","31","32","41","42","5"],
    "A321": ["11","12","21","22","23","31","32","33","41","42","5"],
    "A330": ["1","2","3","4","5"],
    "A350": ["1","2","3","4","5"],
    "B777": ["1","2","3","4","5"],
    "B787": ["1","2","3","4","5"],
    "A319B": ["1","4.5"],
    "A320B": ["1","3","4","5"],
    "A321B": ["1","2","3","4","5"]
  };

  let compartments = [];

  function tailSuffix(){
    const t = ($("tailNo").value || "").toUpperCase().replaceAll(" ", "");
    if(!t) return "";
    const m = t.match(/([A-Z0-9]{3})$/);
    return m ? m[1] : "";
  }

  function calcAvgBag(){
    const totalKg = safeNum($("bagTotalKg").value);
    const pcs = safeNum($("bagPieces").value);
    if(totalKg===null || pcs===null || pcs<=0){
      $("avgBag").value = "";
      return {avg:0, ok:false};
    }
    const avg = totalKg / pcs;
    $("avgBag").value = avg.toFixed(2);
    return {avg, ok:true};
  }

  function calcFuel(){
    const totalVal = $("totalFuel").value;
    const taxiVal  = $("taxiFuel").value;
    const total = safeNum(totalVal) ?? 0;
    const taxi  = safeNum(taxiVal)  ?? 0;
    $("totalFuelEcho").textContent = (totalVal==="" ? "—" : total.toFixed(0) + " kg");
    $("taxiFuelEcho").textContent  = (taxiVal==="" ? "—" : taxi.toFixed(0) + " kg");
    if(totalVal==="" && taxiVal===""){ $("remainFuel").textContent="—"; return; }
    $("remainFuel").textContent = (total - taxi).toFixed(0) + " kg";
  }

  function updateMetaLine(){
    const tail = ($("tailNo").value || "—").trim().toUpperCase();
    const crew = $("crewCode").value || "—";
    const ac = $("aircraft").value || "—";
    $("metaLine").value = `${tail} • ${crew} • ${ac}`;
  }

  // ===== WATER DB (from your table) =====
  const waterDB = {
    "B738": {"25%":{w:-177,i:-2.5},"50%":{w:-118,i:-1.7},"75%":{w:-59,i:-0.8}},
    "B739": {"25%":{w:-178,i:-2.7},"50%":{w:-119,i:-1.8},"75%":{w:-59,i:-0.9}},
    "A319": {"25%":{w:-150,i:-1.7},"50%":{w:-100,i:-1.1},"75%":{w:-50,i:-0.6}},
    "A320": {"25%":{w:-150,i:+0.5},"50%":{w:-100,i:+0.3},"75%":{w:-50,i:+0.2}},
    "A321": {"25%":{w:-150,i:-2.3},"50%":{w:-100,i:-1.6},"75%":{w:-50,i:-0.8}},
    "B787": {"1/8":{w:-924,i:-3.9},"2/8":{w:-792,i:-3.3},"3/8":{w:-660,i:-2.8},"4/8":{w:-528,i:-2.2},"5/8":{w:-396,i:-1.7},"6/8":{w:-264,i:-1.1},"7/8":{w:-132,i:-0.6}},
    "B777": {"1/8":{w:-1172,i:-3.9},"2/8":{w:-1004,i:-3.3},"3/8":{w:837,i:-2.8},"4/8":{w:-670,i:-2.2},"5/8":{w:-502,i:-1.6},"6/8":{w:-335,i:-1.1},"7/8":{w:-167,i:-0.5}},
    "A350_AC": {"1/10":{w:-954,i:-4.4},"2/10":{w:-848,i:-3.9},"3/10":{w:-742,i:-3.4},"4/10":{w:-636,i:-2.9},"5/10":{w:-530,i:-2.4},"6/10":{w:-424,i:-1.9},"7/10":{w:-318,i:-1.5},"8/10":{w:-212,i:-1.0},"9/10":{w:-106,i:-0.5}},
    "A350_BD": {"1/10":{w:-1350,i:-6.0},"2/10":{w:-1200,i:-5.4},"3/10":{w:-1050,i:-4.7},"4/10":{w:-900,i:-4.0},"5/10":{w:-750,i:-3.3},"6/10":{w:-600,i:-2.7},"7/10":{w:-450,i:-2.0},"8/10":{w:-300,i:-1.3},"9/10":{w:-150,i:-0.7}},
    "A330_JNA_JNB": {"25%":{w:-525,i:-2.6},"50%":{w:-350,i:-1.7},"75%":{w:-175,i:-0.9}},
    "A330_GRP2": {"25%":{w:-525,i:-1.6},"50%":{w:-350,i:-1.1},"75%":{w:-175,i:-0.5}},
    "A330_JNF_JNG_JIL_JIM_JIN": {"25%":{w:-788,i:-3.5},"50%":{w:-525,i:-2.4},"75%":{w:-263,i:-1.2}},
    "A330_GRP4": {"25%":{w:-525,i:-2.0},"50%":{w:-350,i:-1.4},"75%":{w:-175,i:-0.9}},
    "A330_TC_LON": {"25%":{w:788,i:-4.2},"50%":{w:525,i:-2.8},"75%":{w:263,i:-1.4}}
  };

  function a350GroupByTail(sfx){
    if(!sfx) return "A350_AC";
    if(sfx.startsWith("LG")){
      const third=sfx[2];
      if("ABCDEFGHMNOP".includes(third)) return "A350_AC";
      if(["I","J","K","L"].includes(third)) return "A350_AC";
      if("RSTUVYZ".includes(third)) return "A350_BD";
    }
    if(sfx.startsWith("LH")){
      const third=sfx[2];
      if("ABCDEFG".includes(third)) return "A350_BD";
      if(["H","I","J"].includes(third)) return "A350_BD";
    }
    return "A350_AC";
  }
  function a330GroupByTail(sfx){
    if(!sfx) return "";
    if(sfx==="JNA"||sfx==="JNB") return "A330_JNA_JNB";
    if(["JNF","JNG","JIL","JIM","JIN"].includes(sfx)) return "A330_JNF_JNG_JIL_JIM_JIN";
    if(sfx==="LON") return "A330_TC_LON";
    if(["JNC","JND","JNE"].includes(sfx)) return "A330_GRP2";
    if(sfx.startsWith("JI") && ["O","P","R","S","T","V","Y","Z"].includes(sfx[2])) return "A330_GRP2";
    if(["LNB","LOH","LOI","LOM"].includes(sfx)) return "A330_GRP2";
    if(sfx.startsWith("JN") && sfx[2] >= "H" && sfx[2] <= "Z") return "A330_GRP4";
    if(["LNC","LND","LNE","LNF","LNG"].includes(sfx)) return "A330_GRP4";
    if(sfx.startsWith("JO")) return "A330_GRP4";
    if(sfx.startsWith("LO")) return "A330_GRP4";
    return "";
  }
  function waterKeyForAircraft(ac){
    if(!ac) return "";
    if(ac==="A350") return a350GroupByTail(tailSuffix());
    if(ac==="A330") return a330GroupByTail(tailSuffix());
    return ac;
  }
  function populateWaterOptions(){
    const ac = $("aircraft").value;
    const sfx = tailSuffix();
    const key = waterKeyForAircraft(ac);
    const sel = $("waterRatio");
    const old = sel.value;
    sel.innerHTML = '<option value="">Seçiniz</option>';
    $("waterWeight").textContent="—"; $("waterIndex").textContent="—";
    if(!ac){ $("waterHint").textContent="Uçak tipi seçince seçenekler gelir."; return; }
    const data = waterDB[key];
    if(!data){ $("waterHint").textContent="Bu uçak/tail için su tablosu yok."; return; }
    if(ac==="A330" && !sfx){ $("waterHint").textContent="A330 için Tail gerekli (son 3)."; }
    else if(ac==="A350" && !sfx){ $("waterHint").textContent="A350 için Tail girersen A-C/B-D seçilir."; }
    else $("waterHint").textContent=`Seçenekler hazır (${key}).`;
    Object.keys(data).forEach(r=>{ const o=document.createElement("option"); o.value=r; o.textContent=r; sel.appendChild(o); });
    if(old && data[old]) sel.value=old;
    updateWaterBox();
  }
  function updateWaterBox(){
    const ac=$("aircraft").value;
    const key=waterKeyForAircraft(ac);
    const ratio=$("waterRatio").value;
    const data=waterDB[key];
    if(!data || !ratio || !data[ratio]){ $("waterWeight").textContent="—"; $("waterIndex").textContent="—"; return; }
    $("waterWeight").textContent = `${data[ratio].w} kg`;
    $("waterIndex").textContent = `${data[ratio].i}`;
  }

  // ===== Comp list renderer =====
  function renderCompList(){
    const list = $("compList");
    list.innerHTML = "";
    compartments.forEach(c=>{
      const wrap=document.createElement("div");
      wrap.className="compItem";
      wrap.innerHTML = `
        <div class="compTop">
          <div class="compName">Comp ${c.name}</div>
          <div class="compMini">Toplam: <span class="miniVal" id="ct_${c.name}">0.0</span> kg</div>
        </div>
        <div class="row2">
          <div class="field">
            <label>Bag PCS</label>
            <input class="cellInput" type="number" inputmode="numeric" placeholder="0" id="b_${c.name}">
          </div>
          <div class="field">
            <label>Cargo KG</label>
            <input class="cellInput" type="number" inputmode="numeric" placeholder="0" id="g_${c.name}">
          </div>
        </div>
        <div class="qbtnRow">
          <button type="button" class="qbtn" data-add="1">+1</button>
          <button type="button" class="qbtn" data-add="5">+5</button>
          <button type="button" class="qbtn" data-add="10">+10</button>
          <button type="button" class="qbtn" data-clear="1">Temizle</button>
        </div>
        <div class="hint">Bag KG otomatik: PCS × Avg.</div>
        <div class="lockNote" id="lock_${c.name}">⚠️ Avg Bagaj yok. Önce Toplam Bagaj KG ve PCS gir.</div>
      `;
      list.appendChild(wrap);
    });

    // listeners
    compartments.forEach((c, idx)=>{
      const b = document.getElementById(`b_${c.name}`);
      const g = document.getElementById(`g_${c.name}`);
      const card = b.closest(".compItem");

      card.querySelectorAll(".qbtn").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          if(btn.dataset.clear){
            b.value=""; g.value=""; c.bags=null; c.cargo=null; updateValues(); b.focus(); return;
          }
          const add=Number(btn.dataset.add||0);
          const cur=(b.value===""?0:Number(b.value));
          const next=(Number.isFinite(cur)?cur:0)+add;
          b.value=String(next); c.bags=next; updateValues(); g.focus();
        });
        btn.addEventListener("touchstart", ()=>{
          // iOS local file reliability
          if(btn.dataset.clear){
            b.value=""; g.value=""; c.bags=null; c.cargo=null; updateValues(); b.focus(); return;
          }
          const add=Number(btn.dataset.add||0);
          const cur=(b.value===""?0:Number(b.value));
          const next=(Number.isFinite(cur)?cur:0)+add;
          b.value=String(next); c.bags=next; updateValues(); g.focus();
        }, {passive:true});
      });

      function goNext(){
        const nx = compartments[idx+1];
        if(!nx) return;
        const nb = document.getElementById(`b_${nx.name}`);
        nb?.focus();
      }

      b.addEventListener("input", ()=>{ c.bags = b.value===""?null:parseFloat(b.value); updateValues(); });
      g.addEventListener("input", ()=>{ c.cargo= g.value===""?null:parseFloat(g.value); updateValues(); });

      b.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); g.focus(); }});
      g.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); goNext(); }});
    });
  }

  
  function getGroupKey(name){
    // bulk style like "4.5" keep as itself
    if(String(name).includes(".")) return String(name);
    // two-digit like 11,12,13 -> group by tens (1,2,3,4)
    if(/^\d{2}$/.test(String(name))) return String(name)[0]; 
    // single digit like 1..5 -> group itself
    return String(name);
  }

  function groupLabel(key){
    // label using actual members present
    const members = compartments.map(c=>String(c.name)).filter(n=>getGroupKey(n)===key);
    members.sort((a,b)=>{
      const na=parseFloat(a), nb=parseFloat(b);
      if(Number.isFinite(na)&&Number.isFinite(nb)) return na-nb;
      return a.localeCompare(b);
    });
    if(!members.length) return key;
    // If group is tens-based, show e.g. "11+12(+13)"
    if(key.length===1 && members[0].length===2){
      return members.join("+");
    }
    // else show single comp keys joined (for safety)
    return members.join("+");
  }

  function renderGroupTotals(groupTotals){
    const box = $("groupTotals");
    if(!box) return;
    const keys = Object.keys(groupTotals);
    if(!keys.length){
      box.style.display="none";
      box.innerHTML="";
      return;
    }
    box.style.display="block";
    // Stable ordering: numeric keys first
    keys.sort((a,b)=>{
      const na=parseFloat(a), nb=parseFloat(b);
      const aNum=Number.isFinite(na), bNum=Number.isFinite(nb);
      if(aNum && bNum) return na-nb;
      if(aNum) return -1;
      if(bNum) return 1;
      return a.localeCompare(b);
    });

    box.innerHTML = `<div class="groupGrid">` + keys.map(k=>{
      return `<div class="gStat"><div class="k">${groupLabel(k)}</div><div class="v">${groupTotals[k].toFixed(1)} kg</div></div>`;
    }).join("") + `</div>`;
  }


function updateValues(){
    try{
      const avgRes = calcAvgBag();
      const avg = avgRes.avg;
      updateMetaLine();
      calcFuel();
      populateWaterOptions();

      const lockComps = (!avgRes.ok) && compartments.some(c => (c.bags||0) > 0);
      compartments.forEach(c=>{
        const b = document.getElementById(`b_${c.name}`);
        const g = document.getElementById(`g_${c.name}`);
        const ln= document.getElementById(`lock_${c.name}`);
        if(b) b.disabled = lockComps;
        if(g) g.disabled = lockComps;
        if(ln) ln.style.display = lockComps ? "block":"none";
      });

      let totalBag=0, totalCargo=0;
      compartments.forEach(c=>{
        const groupTotals = {};
              const bagKg = (c.bags||0)*avg;
        const total = bagKg + (c.cargo||0);
        const gk = getGroupKey(c.name);
        groupTotals[gk] = (groupTotals[gk] || 0) + total;
        const el = document.getElementById(`ct_${c.name}`);
        if(el) el.textContent = total.toFixed(1);
        totalBag += bagKg;
        totalCargo += (c.cargo||0);
      });
      renderGroupTotals(groupTotals);
      $("sumBag").textContent = totalBag.toFixed(1);
      $("sumCargo").textContent = totalCargo.toFixed(1);
      $("sumTotal").textContent = (totalBag+totalCargo).toFixed(1);

      if(lockComps){
        setChip("statusChipL","warn","Avg eksik → Komp kilitli");
      }else{
        setChip("statusChipL","", "Aktif");
      }
    }catch(e){
      console.error(e);
      setChip("statusChipL","bad","Hata");
    }
  }

  function resetAll(){
    ["tailNo","crewCode","aircraft","bagTotalKg","bagPieces","avgBag","metaLine","totalFuel","taxiFuel"].forEach(id=>{
      const el=$(id); if(!el) return;
      if(el.tagName==="SELECT") el.value=""; else el.value="";
    });
    compartments=[];
    $("compList").innerHTML="";
    $("compList").style.display="none";
    renderGroupTotals({});
    $("sumBag").textContent="0.0"; $("sumCargo").textContent="0.0"; $("sumTotal").textContent="0.0";
    $("waterRatio").innerHTML='<option value="">Seçiniz</option>';
    $("waterWeight").textContent="—"; $("waterIndex").textContent="—";
    localStorage.removeItem("loadcalc_v18");
    setChip("statusChipL","","Aktif");
  }

  function saveLocal(){
    const payload = {
      tailNo:$("tailNo").value,
      crewCode:$("crewCode").value,
      aircraft:$("aircraft").value,
      bagTotalKg:$("bagTotalKg").value,
      bagPieces:$("bagPieces").value,
      totalFuel:$("totalFuel").value,
      taxiFuel:$("taxiFuel").value,
      waterRatio:$("waterRatio").value,
      compartments: compartments
    };
    localStorage.setItem("loadcalc_v18", JSON.stringify(payload));
    setChip("statusChipL","","Kaydedildi");
    setTimeout(()=>setChip("statusChipL","","Aktif"), 900);
  }

  function loadLocal(){
    try{
      const raw = localStorage.getItem("loadcalc_v18");
      if(!raw) return;
      const p = JSON.parse(raw);

      $("tailNo").value=p.tailNo||"";
      $("crewCode").value=p.crewCode||"";
      $("aircraft").value=p.aircraft||"";
      $("bagTotalKg").value=p.bagTotalKg||"";
      $("bagPieces").value=p.bagPieces||"";
      $("totalFuel").value=p.totalFuel||"";
      $("taxiFuel").value=p.taxiFuel||"";

      const ac = $("aircraft").value;
      if(ac){
        let loadKey=ac;
        if(ac==="B738"||ac==="B739") loadKey="B737";
        if(aircraftComps[loadKey]){
          compartments = aircraftComps[loadKey].map(name=>{
            const f=(p.compartments||[]).find(x=>x.name===name);
            return {name, bags: f?.bags ?? null, cargo: f?.cargo ?? null};
          });
          $("compList").style.display="block";
          renderCompList();
          compartments.forEach(c=>{
            const b=document.getElementById(`b_${c.name}`);
            const g=document.getElementById(`g_${c.name}`);
            if(b && c.bags!==null) b.value=c.bags;
            if(g && c.cargo!==null) g.value=c.cargo;
          });
        }
      }
      populateWaterOptions();
      if(p.waterRatio) $("waterRatio").value=p.waterRatio;
      updateWaterBox();
      updateValues();
    }catch(e){ console.error(e); }
  }

  $("aircraft").addEventListener("change", ()=>{
    const ac=$("aircraft").value;
    compartments=[];
    let loadKey=ac;
    if(ac==="B738"||ac==="B739") loadKey="B737";
    if(loadKey && aircraftComps[loadKey]){
      aircraftComps[loadKey].forEach(name=>compartments.push({name, bags:null, cargo:null}));
      $("compList").style.display="block";
      renderCompList();
    }else{
      $("compList").style.display="none";
      $("compList").innerHTML="";
      renderGroupTotals({});
    }
    populateWaterOptions();
    updateValues();
  });

  $("tailNo").addEventListener("input", ()=>{ populateWaterOptions(); updateMetaLine(); });
  $("waterRatio").addEventListener("change", updateWaterBox);
  ["crewCode","bagTotalKg","bagPieces","totalFuel","taxiFuel"].forEach(id=>{
    $(id).addEventListener("input", updateValues);
    $(id).addEventListener("change", updateValues);
  });

  bindTap("btnReset", resetAll);
  bindTap("btnSave", saveLocal);
  bindTap("btnClearComps", ()=>{
    compartments.forEach(c=>{c.bags=null; c.cargo=null;});
    compartments.forEach(c=>{
      const b=document.getElementById(`b_${c.name}`); const g=document.getElementById(`g_${c.name}`);
      if(b) b.value=""; if(g) g.value="";
      const t=document.getElementById(`ct_${c.name}`); if(t) t.textContent="0.0";
    });
    updateValues();
  });

  // ===== RADIOACTIVE =====
  const radHeights = {
    "A319":{"1":"1.24","4":"1.24-1.20","51":"1.20-0.82"},
    "A320":{"1":"1.24","3":"1.24","4":"1.24-1.20","51":"1.20-0.82"},
    "A321":{"1":"1.24","2":"1.24","3":"1.24","4":"1.24-1.20","51":"1.20-0.82"},

    // A330: tabloda 2 ve 4 boş; pratik kullanım için 2=1 ile, 4=3 ile aynı kabul edildi
    "A330-200":{"1":"1.71","2":"1.71","3":"1.67","4":"1.67","51":"1.79","52":"1.81","53":"1.50"},
    "A330-300":{"1":"1.71","2":"1.71","3":"1.67","4":"1.67","51":"1.79","52":"1.81","53":"1.50"},

    // A350: tabloda 2 ve 4 boş; pratik kullanım için 2=1 ile, 4=3 ile aynı kabul edildi
    "A350":{"1":"1.76","2":"1.76","3":"1.75","4":"1.75","51":"1.76"},

    "B737-800":{"1":"1.11","3":"1.19","4":"0.95-0.59"},
    "B737-900":{"1":"1.11","3":"1.19","4":"0.95-0.59"},

    // B787/B777: tabloda BULK değeri aralık olarak verilmiş (1.70-1.49 / 1.67-1.56)
    // pratik kullanım için 2=1 ile, 4=3 ile aynı kabul edildi
    "B787":{"1":"1.70","2":"1.70","3":"1.70","4":"1.70","51":"1.70-1.49","52":"1.70-1.49"},
    "B777":{"1":"1.67","2":"1.67","3":"1.67","4":"1.67","51":"1.67-1.56","52":"1.67-1.56"}
  };
  const tiBands = [
    {min:0.1,max:1.0,dist:0.30},{min:1.1,max:2.0,dist:0.50},{min:2.1,max:3.0,dist:0.70},
    {min:3.1,max:4.0,dist:0.85},{min:4.1,max:5.0,dist:1.00},{min:5.1,max:6.0,dist:1.15},
    {min:6.1,max:7.0,dist:1.30},{min:7.1,max:8.0,dist:1.45},{min:8.1,max:9.0,dist:1.55},
    {min:9.1,max:10.0,dist:1.65},{min:10.1,max:11.0,dist:1.75}
  ];
  function parseHeightMeters(s){
    if(!s) return null;
    const nums = String(s).split("-").map(x=>parseFloat(x)).filter(n=>Number.isFinite(n));
    if(!nums.length) return null;
    return Math.min(...nums);
  }
  function parseTISum(text){
    if(text===null||text===undefined) return null;
    const s=String(text).trim(); if(!s) return null;
    const parts=s.split(/[\+,; ]+/).filter(Boolean);
    const nums=parts.map(p=>Number(String(p).replace(",", "."))).filter(n=>Number.isFinite(n));
    if(!nums.length) return null;
    return nums.reduce((a,b)=>a+b,0);
  }
  function tiToMinDistance(ti){
    if(!Number.isFinite(ti)) return null;
    for(const b of tiBands){ if(ti>=b.min && ti<=b.max) return b.dist; }
    return null;
  }
  function populateRadComp(){
    const ac=$("radAircraft").value;
    const sel=$("radComp");
    const old=sel.value;
    sel.innerHTML='<option value="">Seçiniz</option>';
    $("radCompHint").textContent = ac ? "Kompartman seç. Not: Bazı tiplerde tabloda 2/4 boştu → 2=1, 4=3 olarak eşlendi." : "Uçak tipini seç.";
    const data=radHeights[ac];
    if(!data) return;
    Object.keys(data).forEach(comp=>{
      const o=document.createElement("option");
      o.value=comp;
      let label = comp;
      if((ac==="A330-200"||ac==="A330-300"||ac==="A350"||ac==="B787"||ac==="B777") && (comp==="2"||comp==="4")){
        label = (comp==="2") ? "2 (1 ile aynı)" : "4 (3 ile aynı)";
      }
      o.textContent=label;
      sel.appendChild(o);
    });
    if(old && data[old]) sel.value=old;
  }
  function updateRadCalc(){
    const ac=$("radAircraft").value;
    const comp=$("radComp").value;
    const ti=parseTISum($("radTI").value);
    const boxH=safeNum($("radBoxHcm").value);
    $("radSumTI").textContent = (ti===null) ? "—" : ti.toFixed(2);

    const hStr=(radHeights[ac]||{})[comp];
    const hM=parseHeightMeters(hStr);
    const hCm=(hM===null)?null:(hM*100);

    const minM=tiToMinDistance(ti);
    $("radMinM").textContent = (minM===null) ? "—" : (minM.toFixed(2)+" m");
    $("radCompCm").textContent = (hCm===null) ? "—" : (hCm.toFixed(0)+" cm");

    if(minM===null){ $("radNeedCm").textContent="—"; $("radResult").textContent="TI gir."; return; }
    if(boxH===null || boxH<0){ $("radNeedCm").textContent="—"; $("radResult").textContent="Kutu yüksekliği gir."; return; }
    const need=minM*100 + boxH;
    $("radNeedCm").textContent = need.toFixed(0)+" cm";
    if(hCm===null){ $("radResult").textContent="Kompartman seç."; return; }
    if(need<=hCm+1e-6){ $("radResult").textContent = `✅ UYGUN (pay: ${(hCm-need).toFixed(0)} cm)`; }
    else{ $("radResult").textContent = `❌ UYGUN DEĞİL (aşıyor: ${(need-hCm).toFixed(0)} cm)`; }
  }

  $("radAircraft").addEventListener("change", ()=>{ populateRadComp(); updateRadCalc(); });
  $("radComp").addEventListener("change", updateRadCalc);
  ["radTI","radBoxHcm"].forEach(id=>{ $(id).addEventListener("input", updateRadCalc); $(id).addEventListener("change", updateRadCalc); });

  // boot
  loadLocal();
  updateValues();
</script>
</body>
</html>
