<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Uçak Yükleme Hesaplama (Mobil v7)</title>
  <style>
    :root{
      --bg:#0b0b0b; --card:#151515; --card2:#101010;
      --text:#ffffff; --muted:#bdbdbd; --border:#2d2d2d;
      --accent:#00e0ff; --warn:#ffcc00; --bad:#ff4d4d;
      --shadow: 0 10px 30px rgba(0,0,0,.45); --r:16px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .wrap{ max-width: 600px; margin: 0 auto; padding: 14px 14px 160px; }
    header{
      position: sticky; top: 0; z-index: 20;
      background: linear-gradient(to bottom, rgba(11,11,11,0.98), rgba(11,11,11,0.86));
      backdrop-filter: blur(10px);
      padding: 10px 0 10px; margin: 0 0 12px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .titleRow{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; padding: 0 2px; }
    h1{ font-size: 18px; margin:0; letter-spacing:.2px; font-weight: 900; }
    .sub{
      margin-top:6px; font-size: 12px; color: var(--muted);
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
    }
    .pill,.chip{
      font-size: 12px; color: var(--muted);
      border: 1px solid var(--border);
      padding: 6px 10px; border-radius: 999px;
      background: rgba(255,255,255,0.03); white-space:nowrap;
    }
    .chip.bad{ color: #fff; border-color: rgba(255,77,77,.5); background: rgba(255,77,77,.12); }
    .chip.warn{ color: #fff; border-color: rgba(255,204,0,.55); background: rgba(255,204,0,.12); }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 14px; margin-bottom: 12px;
    }
    .card.secondary{ background: var(--card2); }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .grid3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

    label{
      display:block; font-size: 13px; color: var(--muted);
      margin: 0 0 6px; font-weight: 750; letter-spacing:.2px;
    }
    .field{ display:flex; flex-direction:column; }

    select, input[type="number"], input[type="text"]{
      width:100%;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 18px;
      outline: none;
    }
    select{
      appearance: none; -webkit-appearance: none; -moz-appearance: none;
      padding-right: 44px;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(255,255,255,0.7) 50%),
        linear-gradient(135deg, rgba(255,255,255,0.7) 50%, transparent 50%),
        linear-gradient(to right, transparent, transparent);
      background-position:
        calc(100% - 18px) calc(50% - 4px),
        calc(100% - 12px) calc(50% - 4px),
        100% 0;
      background-size: 6px 6px, 6px 6px, 2.6em 2.6em;
      background-repeat: no-repeat;
    }
    option{ background: #101010; color: #ffffff; }
    input[type="number"]{ -moz-appearance: textfield; }
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button{ -webkit-appearance: none; margin: 0; }

    select:focus, input:focus{
      border-color: rgba(0,224,255,.75);
      box-shadow: 0 0 0 3px rgba(0,224,255,.15);
    }
    input[readonly]{ opacity: .92; background: rgba(255,255,255,0.04); }

    .hint{ margin-top: 8px; color: var(--muted); font-size: 12px; line-height: 1.25rem; }
    .divider{ height:1px; background: var(--border); margin: 12px 0; opacity:.8; }

    .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 6px; }
    button{
      appearance:none; border:none; cursor:pointer;
      border-radius: 14px; padding: 12px 14px;
      font-size: 14px; font-weight: 850; letter-spacing:.2px;
      color: var(--text);
      background: rgba(255,255,255,0.08);
      border: 1px solid var(--border);
      min-height: 44px;
      flex: 1 1 auto;
    }
    button:active{ transform: translateY(1px); }
    .btn-primary{
      background: linear-gradient(180deg, rgba(0,224,255,.25), rgba(0,224,255,.12));
      border-color: rgba(0,224,255,.35);
    }
    .btn-danger{
      background: linear-gradient(180deg, rgba(255,60,60,.22), rgba(255,60,60,.10));
      border-color: rgba(255,60,60,.35);
    }

    .stat{
      display:flex; flex-direction:column; gap:6px;
      padding: 12px; border-radius: 14px;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      min-width: 140px;
    }
    .stat .k{ color: var(--muted); font-size: 12px; font-weight:750; }
    .stat .v{ color: var(--accent); font-size: 18px; font-weight: 950; letter-spacing:.2px; }
    .stat .v.warn{ color: var(--warn); }

    .compBar{
      display:flex; gap:10px; overflow-x:auto; -webkit-overflow-scrolling: touch;
      padding-bottom: 6px; margin-top: 10px;
    }
    .compBar::-webkit-scrollbar{ height: 6px; }
    .compBar::-webkit-scrollbar-thumb{ background: rgba(255,255,255,0.12); border-radius: 999px; }

    .tableWrap{
      overflow-x: auto; -webkit-overflow-scrolling: touch;
      border-radius: 14px; border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
    }
    table{ width: 100%; border-collapse: collapse; min-width: 520px; }
    th, td{
      padding: 10px 8px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      text-align:center; font-size: 13px;
    }
    th{
      position: sticky; top: 0;
      background: #1b1b1b; z-index: 2;
      font-size: 12px; color: var(--muted);
      letter-spacing:.3px; text-transform: uppercase;
    }
    td.num{ text-align:right; font-variant-numeric: tabular-nums; }
    td.comp{ font-weight: 900; }
    .cellInput{
      width: 92px; max-width: 100%;
      margin: 0 auto; padding: 10px 10px;
      font-size: 16px; border-radius: 12px;
    }
    tr.totalRow{ background: rgba(255,255,255,0.04); }
    tr.totalRow td{ font-weight: 900; }
    tr.totalRow td:last-child{ color: var(--warn); }

    .sticky{
      position: fixed; left: 0; right: 0; bottom: 0;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: linear-gradient(to top, rgba(11,11,11,0.98), rgba(11,11,11,0.86));
      border-top: 1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(10px);
      z-index: 30;
    }
    .stickyInner{
      max-width: 600px; margin: 0 auto;
      display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;
    }
    .sticky .stat{ box-shadow:none; min-width: unset; }

    @media (max-width:420px){
      .grid2, .grid3{ grid-template-columns: 1fr; }
      table{ min-width: 480px; }
      .cellInput{ width: 84px; }
      .stat{ min-width: 0; }
    }
  
    /* Modal */
    .modalBack{
      position: fixed; inset:0; z-index: 80;
      background: rgba(0,0,0,.65);
      display:none;
      padding: 14px 14px calc(14px + env(safe-area-inset-bottom));
    }
    .modal{
      max-width: 600px;
      margin: 0 auto;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 14px;
      max-height: calc(100vh - 40px);
      overflow:auto;
    }
    .modalTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      position: sticky; top: 0;
      background: linear-gradient(to bottom, rgba(21,21,21,0.98), rgba(21,21,21,0.9));
      padding-bottom: 10px;
      margin-bottom: 10px;
      z-index: 2;
    }
    .modalTop h2{ margin:0; font-size: 16px; font-weight: 950; letter-spacing:.2px; }
    .btnSmall{
      padding: 10px 12px; min-height: 40px; border-radius: 12px;
      font-size: 13px; font-weight: 900;
    }

  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="titleRow">
        <div>
          <h1>Uçak Yükleme Hesaplama</h1>
          <div class="sub">
            <span class="pill" id="clockPill">—</span>
            <span class="pill" id="datePill">—</span>
            <button class="pill" id="radOpen" type="button" style="cursor:pointer;">☢️ Radyoaktif</button>
          </div>
        </div>
        <div class="chip" id="statusChip">Hazır</div>
      </div>
    </header>

    <div class="card">
      <div class="grid2">
        <div class="field">
          <label>Uçak Kuyruğu (Tail)</label>
          <input type="text" id="tailNo" placeholder="örn. TC-LGA / TC-JNA" autocapitalize="characters" />
          <div class="hint">Sadece kontrol amaçlı. Tail'in son 3 harfine göre su tablosu seçilir.</div>
        </div>

        <div class="field">
          <label>Crew (Gösterge)</label>
          <select id="crewCode">
            <option value="">Seçiniz</option>
            <optgroup label="2/ ...">
              <option>2/0</option><option>2/4</option><option>2/5</option><option>2/6</option>
              <option>2/10</option><option>2/11</option><option>2/12</option><option>2/14</option>
            </optgroup>
            <optgroup label="3/ ...">
              <option>3/0</option><option>3/4</option><option>3/5</option><option>3/6</option>
              <option>3/10</option><option>3/11</option><option>3/12</option><option>3/14</option>
            </optgroup>
          </select>
        </div>
      </div>

      <div class="divider"></div>

      <div class="grid2">
        <div class="field">
          <label>Uçak Tipi</label>
          <select id="aircraft">
            <option value="">Seçiniz</option>
            <option value="B738">B-737 / 800</option>
            <option value="B739">B-737 / 900</option>
            <option value="A319">A-319</option>
            <option value="A320">A-320</option>
            <option value="A321">A-321</option>
            <option value="A330">A-330</option>
            <option value="B787">B-787</option>
            <option value="B777">B-777</option>
            <option value="A350">A-350</option>

            <optgroup label="(Bulk - yük tablosu için)">
              <option value="A319B">A319 Bulk</option>
              <option value="A320B">A320 Bulk</option>
              <option value="A321B">A321 Bulk</option>
            </optgroup>
          </select>
          <div class="hint">Not: Su tablosu görüntüdeki tipe göre ayarlanır.</div>
        </div>

        <div class="field">
          <label>Hızlı İşlemler</label>
          <div class="btns">
            <button class="btn-primary" id="btnSave">Kaydet</button>
            <button class="btn-danger" id="btnReset">Sıfırla</button>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Bag -->
      <div class="grid2">
        <div class="field">
          <label>Toplam Bagaj Ağırlığı (kg)</label>
          <input type="number" id="bagTotalKg" inputmode="numeric" placeholder="örn. 2450" />
        </div>
        <div class="field">
          <label>Bagaj Parça Sayısı (PCS)</label>
          <input type="number" id="bagPieces" inputmode="numeric" placeholder="örn. 122" />
        </div>
      </div>

      <div class="grid2" style="margin-top:10px;">
        <div class="field">
          <label>Ortalama Bagaj (kg) — otomatik</label>
          <input type="text" id="avgBag" readonly value="" placeholder="—" />
          <div class="hint">Toplam Bagaj Kg / PCS</div>
        </div>

        <div class="field">
          <label>Meta</label>
          <input type="text" id="metaLine" readonly value="" placeholder="—" />
          <div class="hint">Tail • Crew • Aircraft</div>
        </div>
      </div>
    </div>

    <!-- Water (SU) -->
    <div class="card secondary">
      <div class="grid2">
        <div class="field">
          <label>Su Oranı</label>
          <select id="waterRatio">
            <option value="">Seçiniz</option>
          </select>
          <div class="hint" id="waterHint">Uçak tipi + kuyruk girince seçenekler gelir.</div>
        </div>

        <div class="field">
          <label>Su (Ağırlık / Index)</label>
          <div class="grid2" style="margin-top:0;">
            <div class="stat" style="min-width:unset;">
              <div class="k">Su Ağırlığı</div>
              <div class="v" id="waterWeight">—</div>
            </div>
            <div class="stat" style="min-width:unset;">
              <div class="k">Su Index</div>
              <div class="v warn" id="waterIndex">—</div>
            </div>
          </div>
        </div>
      </div>
      <div class="hint">Kaynak: paylaştığın tabloda (08.01.2026). Seçim: Aircraft + Tail suffix + Su Oranı.</div>
    </div>

    <!-- Fuel -->
    <div class="card secondary">
      <div class="grid2">
        <div class="field">
          <label>Total Fuel (kg)</label>
          <input type="number" id="totalFuel" inputmode="numeric" />
        </div>
        <div class="field">
          <label>Taxi Fuel (kg)</label>
          <input type="number" id="taxiFuel" inputmode="numeric" />
        </div>
      </div>

      <div class="divider"></div>

      <div class="grid3">
        <div class="stat"><div class="k">Total</div><div class="v" id="totalFuelEcho">—</div></div>
        <div class="stat"><div class="k">Remaining</div><div class="v warn" id="remainFuel">—</div></div>
        <div class="stat"><div class="k">Taxi</div><div class="v" id="taxiFuelEcho">—</div></div>
      </div>
      <div class="hint">Remaining = Total − Taxi</div>
    </div>

    <!-- Comp totals bar -->
    <div class="card" id="compTotalsCard" style="display:none;">
      <div style="font-weight:900;">Kompartman Toplamları (kg)</div>
      <div class="compBar" id="compBar"></div>
      <div class="hint">Bulk uçakta gösterilmez. Her kutu: (Bagaj kg + Kargo kg)</div>
    </div>

    <!-- Table -->
    <div class="card">
      <div class="hint">Uçak tipi seçince kompartmanlar açılır. Bag Sayısı ve Kargo Kg gir.</div>
      <div class="tableWrap" style="display:none;" id="tableWrap">
        <table id="table">
          <thead>
            <tr>
              <th>Kompartman</th>
              <th>Bagaj Sayısı</th>
              <th>Bagaj Kg</th>
              <th>Kargo Kg</th>
              <th>Toplam Kg</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="sticky" id="sticky" style="display:none;">
    <div class="stickyInner">
      <div class="stat"><div class="k">Toplam Bagaj</div><div class="v" id="sumBag">0.0</div></div>
      <div class="stat"><div class="k">Toplam Kargo</div><div class="v" id="sumCargo">0.0</div></div>
      <div class="stat"><div class="k">Toplam Yük</div><div class="v" id="sumTotal">0.0</div></div>
    </div>
  </div>


  <!-- RADIOACTIVE MODAL -->
  <div class="modalBack" id="radModalBack" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Radyoaktif Hesaplama">
      <div class="modalTop">
        <h2>☢️ Radyoaktif Mesafe Hesaplama</h2>
        <button class="btnSmall btn-danger" id="radClose" type="button">Kapat</button>
      </div>

      <div class="card secondary" style="box-shadow:none; margin-bottom:12px;">
        <div class="grid2">
          <div class="field">
            <label>Uçak Tipi</label>
            <select id="radAircraft">
              <option value="">Seçiniz</option>
              <option value="A319">A319</option>
              <option value="A320">A320</option>
              <option value="A321">A321</option>
              <option value="A330-200">A330-200</option>
              <option value="A330-300">A330-300</option>
              <option value="A350">A350</option>
              <option value="B737-800">B737-800</option>
              <option value="B737-900">B737-900</option>
              <option value="B787">B787</option>
              <option value="B777">B777</option>
            </select>
            <div class="hint">Kompartman–cabin mesafesi ve TI’ye göre minimum mesafeyi kontrol eder.</div>

            <div class="field" id="a330VariantWrap" style="margin-top:10px; display:none;">
              <label>A330 Variant</label>
              <select id="a330Variant">
                <option value="A330-200">A330-200</option>
                <option value="A330-300">A330-300</option>
              </select>
              <div class="hint">A330 seçiliyse -200 / -300 buradan hızlı değişir.</div>
            </div>
          </div>

          <div class="field">
            <label>Kompartman</label>
            <select id="radComp">
              <option value="">Seçiniz</option>
            </select>
            <div class="hint" id="radCompHint">Uçak tipini seçince uygun kompartmanlar gelir.</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="grid2">
          <div class="field">
            <label>TI Değerleri (otomatik Sum TI)</label>
            <input type="text" id="radTI" inputmode="text" placeholder="örn. 1.5 + 0.3 + 0.2" />
            <div class="hint">Birden fazla TI için “+” veya virgül kullan: 1.5+0.3+0.2</div>
          </div>
          <div class="field">
            <label>Radyoaktif Kutu Yüksekliği (cm)</label>
            <input type="number" id="radBoxHcm" inputmode="numeric" placeholder="örn. 42" />
            <div class="hint">Örnek: 50 cm + 42 cm = 92 cm (mesafe + yükseklik)</div>
          </div>
        </div>
      </div>

      <div class="grid2" style="gap:10px;">
        <div class="stat">
          <div class="k">Sum TI</div>
          <div class="v" id="radSumTI">—</div>
        </div>
        <div class="stat">
          <div class="k">Min Mesafe (m)</div>
          <div class="v" id="radMinM">—</div>
        </div>
        <div class="stat">
          <div class="k">Gerekli Toplam (cm)</div>
          <div class="v warn" id="radNeedCm">—</div>
        </div>
        <div class="stat">
          <div class="k">Kompartman Yüksekliği (cm)</div>
          <div class="v" id="radCompCm">—</div>
        </div>
      </div>

      <div class="card" style="box-shadow:none; margin-top:12px;">
        <div class="stat" style="min-width:unset;">
          <div class="k">Sonuç</div>
          <div class="v" id="radResult">—</div>
        </div>
        <div class="hint">Kural: (Min Mesafe + Kutu Yüksekliği) ≤ Kompartman Yüksekliği.</div>
      </div>
    </div>
  </div>

          <div class="field">
            <label>Kompartman</label>
            <select id="radComp">
              <option value="">Seçiniz</option>
            </select>
            <div class="hint" id="radCompHint">Uçak tipini seçince uygun kompartmanlar gelir.</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="grid2">
          <div class="field">
            <label>TI (veya Sum TI)</label>
            <input type="number" id="radTI" inputmode="decimal" placeholder="örn. 1.5" step="0.1" />
            <div class="hint">TI aralığına göre min mesafe (m) seçilir.</div>
          </div>
          <div class="field">
            <label>Radyoaktif Kutu Boyu (cm)</label>
            <input type="number" id="radBoxCm" inputmode="numeric" placeholder="örn. 42" />
            <div class="hint">Örnek: 50 cm + 42 cm = 92 cm</div>
          </div>
        </div>
      </div>

      <div class="grid3">
        <div class="stat">
          <div class="k">Min Mesafe (m)</div>
          <div class="v" id="radMinM">—</div>
        </div>
        <div class="stat">
          <div class="k">Gerekli Toplam (cm)</div>
          <div class="v warn" id="radNeedCm">—</div>
        </div>
        <div class="stat">
          <div class="k">Kompartman Yüksekliği (cm)</div>
          <div class="v" id="radCompCm">—</div>
        </div>
      </div>

      <div class="card" style="box-shadow:none; margin-top:12px;">
        <div class="stat" style="min-width:unset;">
          <div class="k">Sonuç</div>
          <div class="v" id="radResult">—</div>
        </div>
        <div class="hint">Kural: (Min Mesafe + Kutu Boyu) ≤ Kompartman Yüksekliği.</div>
      </div>
    </div>
  </div>

<script>
  // ===== LOAD (compartment) data =====
  const aircraftComps = {
    "B737": ["1","2","3","4"],
    "A319": ["11","12","41","42","51"],
    "A320": ["11","12","13","31","32","41","42","5"],
    "A321": ["11","12","21","22","23","31","32","33","41","42","5"],
    "A330": ["1","2","3","4","5"],
    "A350": ["1","2","3","4","5"],
    "B777": ["1","2","3","4","5"],
    "B787": ["1","2","3","4","5"],
    "A319B": ["1","4.5"],
    "A320B": ["1","3","4","5"],
    "A321B": ["1","2","3","4","5"]
  };
  const bulkAircraft = new Set(["A319B","A320B","A321B"]);

  // ===== WATER DATA from your image (08.01.2026) =====
  // Each entry: {w: weight, i: index}
  const waterDB = {
    // Narrowbodies
    "B738": { // B-737/800
      "25%": {w:-177, i:-2.5},
      "50%": {w:-118, i:-1.7},
      "75%": {w:-59,  i:-0.8}
    },
    "B739": { // B-737/900
      "25%": {w:-178, i:-2.7},
      "50%": {w:-119, i:-1.8},
      "75%": {w:-59,  i:-0.9}
    },
    "A319": {
      "25%": {w:-150, i:-1.7},
      "50%": {w:-100, i:-1.1},
      "75%": {w:-50,  i:-0.6}
    },
    "A320": {
      "25%": {w:-150, i:+0.5},
      "50%": {w:-100, i:+0.3},
      "75%": {w:-50,  i:+0.2}
    },
    "A321": {
      "25%": {w:-150, i:-2.3},
      "50%": {w:-100, i:-1.6},
      "75%": {w:-50,  i:-0.8}
    },

    // B787
    "B787": {
      "1/8": {w:-924, i:-3.9},
      "2/8": {w:-792, i:-3.3},
      "3/8": {w:-660, i:-2.8},
      "4/8": {w:-528, i:-2.2},
      "5/8": {w:-396, i:-1.7},
      "6/8": {w:-264, i:-1.1},
      "7/8": {w:-132, i:-0.6}
    },

    // B777  (Not: tabloda 3/8 hücresi 837 / -2,8 görünüyor)
    "B777": {
      "1/8": {w:-1172, i:-3.9},
      "2/8": {w:-1004, i:-3.3},
      "3/8": {w:  837, i:-2.8},
      "4/8": {w:-670,  i:-2.2},
      "5/8": {w:-502,  i:-1.6},
      "6/8": {w:-335,  i:-1.1},
      "7/8": {w:-167,  i:-0.5}
    },

    // A350 depends on tail suffix group
    "A350_AC": {
      "1/10": {w:-954, i:-4.4},
      "2/10": {w:-848, i:-3.9},
      "3/10": {w:-742, i:-3.4},
      "4/10": {w:-636, i:-2.9},
      "5/10": {w:-530, i:-2.4},
      "6/10": {w:-424, i:-1.9},
      "7/10": {w:-318, i:-1.5},
      "8/10": {w:-212, i:-1.0},
      "9/10": {w:-106, i:-0.5}
    },
    "A350_BD": {
      "1/10": {w:-1350, i:-6.0},
      "2/10": {w:-1200, i:-5.4},
      "3/10": {w:-1050, i:-4.7},
      "4/10": {w:-900,  i:-4.0},
      "5/10": {w:-750,  i:-3.3},
      "6/10": {w:-600,  i:-2.7},
      "7/10": {w:-450,  i:-2.0},
      "8/10": {w:-300,  i:-1.3},
      "9/10": {w:-150,  i:-0.7}
    },

    // A330 depends on tail suffix group
    "A330_JNA_JNB": {
      "25%": {w:-525, i:-2.6},
      "50%": {w:-350, i:-1.7},
      "75%": {w:-175, i:-0.9}
    },
    "A330_GRP2": { // JNC/JND/JNE + JI* + LNB/LOH/LOI/LOM
      "25%": {w:-525, i:-1.6},
      "50%": {w:-350, i:-1.1},
      "75%": {w:-175, i:-0.5}
    },
    "A330_JNF_JNG_JIL_JIM_JIN": {
      "25%": {w:-788, i:-3.5},
      "50%": {w:-525, i:-2.4},
      "75%": {w:-263, i:-1.2}
    },
    "A330_GRP4": { // JNH..JNZ + LNC/LND/LNE/LNF/LNG + JOA/JOB/JOC/JOD/JOE/JOF + JOG/JOH/JOJ/JOI/JOK/JOL/JOM + LOA/LOB/LOC/LOD/LOE/LOF + LOG/LOJ/LOK
      "25%": {w:-525, i:-2.0},
      "50%": {w:-350, i:-1.4},
      "75%": {w:-175, i:-0.9}
    },
    "A330_TC_LON": {
      "25%": {w: 788, i:-4.2},
      "50%": {w: 525, i:-2.8},
      "75%": {w: 263, i:-1.4}
    }
  };

  
  
  // ===== RADIOACTIVE (TI + Compartment height) DATA from your image =====
  // Values are compartment height (meters). Ranges like "1.24-1.20" => MIN is the limit.
  const radHeights = {
    "A319": {"1":"1.24","4":"1.24-1.20","51":"1.20-0.82"},
    "A320": {"1":"1.24","3":"1.24","4":"1.24-1.20","51":"1.20-0.82"},
    "A321": {"1":"1.24","2":"1.24","3":"1.24","4":"1.24-1.20","51":"1.20-0.82"},
    "A330-200": {"1":"1.71","3":"1.67","51":"1.79","52":"1.81","53":"1.50"},
    "A330-300": {"1":"1.71","3":"1.67","51":"1.79","52":"1.81","53":"1.50"},
    "A350": {"1":"1.76","3":"1.75","51":"1.76"},
    "B737-800": {"1":"1.11","3":"1.19","4":"0.95-0.59"},
    "B737-900": {"1":"1.11","3":"1.19","4":"0.95-0.59"},
    "B787": {"1":"1.70","3":"1.70","51":"1.70","52":"1.49"},
    "B777": {"1":"1.67","3":"1.67","51":"1.67","52":"1.56"}
  };

  // TI -> Minimum distance (meters)
  const tiBands = [
    {min:0.1, max:1.0,  dist:0.30},
    {min:1.1, max:2.0,  dist:0.50},
    {min:2.1, max:3.0,  dist:0.70},
    {min:3.1, max:4.0,  dist:0.85},
    {min:4.1, max:5.0,  dist:1.00},
    {min:5.1, max:6.0,  dist:1.15},
    {min:6.1, max:7.0,  dist:1.30},
    {min:7.1, max:8.0,  dist:1.45},
    {min:8.1, max:9.0,  dist:1.55},
    {min:9.1, max:10.0, dist:1.65},
    {min:10.1,max:11.0, dist:1.75}
  ];

  function parseHeightMeters(s){
    if(!s) return null;
    const parts = String(s).split("-").map(x=>parseFloat(x));
    const nums = parts.filter(x=>Number.isFinite(x));
    if(!nums.length) return null;
    return Math.min(...nums);
  }

  function parseTISum(text){
    if(text===null || text===undefined) return null;
    const s = String(text).trim();
    if(!s) return null;
    const parts = s.split(/[\+,; ]+/).filter(Boolean);
    const nums = parts.map(p=>Number(String(p).replace(",", "."))).filter(n=>Number.isFinite(n));
    if(!nums.length) return null;
    return nums.reduce((a,b)=>a+b, 0);
  }

  function tiToMinDistance(ti){
    if(!Number.isFinite(ti)) return null;
    for(const b of tiBands){
      if(ti >= b.min && ti <= b.max) return b.dist;
    }
    return null;
  }

  function mapMainAircraftToRad(){
    const ac = $("aircraft").value;
    if(ac==="B738") return "B737-800";
    if(ac==="B739") return "B737-900";
    if(ac==="B787") return "B787";
    if(ac==="B777") return "B777";
    if(ac==="A350") return "A350";
    if(ac==="A330") return "A330-300"; // default
    if(["A319","A320","A321"].includes(ac)) return ac;
    return "";
  }

  function syncA330VariantUI(){
    const ac = $("radAircraft").value;
    if(ac==="A330-200" || ac==="A330-300"){
      $("a330VariantWrap").style.display = "block";
      $("a330Variant").value = ac;
    }else{
      $("a330VariantWrap").style.display = "none";
    }
  }

  function populateRadComp(){
    const ac = $("radAircraft").value;
    const sel = $("radComp");
    const old = sel.value;
    sel.innerHTML = `<option value="">Seçiniz</option>`;
    $("radCompHint").textContent = ac ? "Kompartman seç." : "Uçak tipini seçince uygun kompartmanlar gelir.";

    const data = radHeights[ac];
    if(!data) return;

    Object.keys(data).forEach(comp=>{
      const opt = document.createElement("option");
      opt.value = comp;
      opt.textContent = comp;
      sel.appendChild(opt);
    });

    if(old && data[old]) sel.value = old;
  }

  function updateRadCalc(){
    const ac = $("radAircraft").value;
    const comp = $("radComp").value;
    const ti = parseTISum($("radTI").value);
    const boxHcm = safeNum($("radBoxHcm").value);

    $("radSumTI").textContent = (ti===null) ? "—" : ti.toFixed(2);

    const hStr = (radHeights[ac]||{})[comp];
    const hM = parseHeightMeters(hStr);
    const hCm = (hM===null) ? null : (hM*100);

    const minM = tiToMinDistance(ti);

    $("radMinM").textContent = (minM===null) ? "—" : (minM.toFixed(2) + " m");
    $("radCompCm").textContent = (hCm===null) ? "—" : (hCm.toFixed(0) + " cm");

    if(minM===null){
      $("radNeedCm").textContent = "—";
      $("radResult").textContent = "TI gir (tek veya çoklu).";
      return;
    }
    if(boxHcm===null || boxHcm < 0){
      $("radNeedCm").textContent = "—";
      $("radResult").textContent = "Kutu yüksekliği (cm) gir.";
      return;
    }

    const needCm = minM*100 + boxHcm;
    $("radNeedCm").textContent = needCm.toFixed(0) + " cm";

    if(hCm===null){
      $("radResult").textContent = "Kompartman seç.";
      return;
    }

    const ok = needCm <= hCm + 1e-6;
    if(ok){
      const left = hCm - needCm;
      $("radResult").textContent = `✅ UYGUN (pay: ${left.toFixed(0)} cm)`;
    }else{
      const over = needCm - hCm;
      $("radResult").textContent = `❌ UYGUN DEĞİL (aşıyor: ${over.toFixed(0)} cm)`;
    }
  }

  function openRadModal(){
    $("radModalBack").style.display = "block";
    $("radModalBack").setAttribute("aria-hidden","false");
    const mapped = mapMainAircraftToRad();
    if(mapped) $("radAircraft").value = mapped;
    syncA330VariantUI();
    populateRadComp();
    updateRadCalc();
  }

  function closeRadModal(){
    $("radModalBack").style.display = "none";
    $("radModalBack").setAttribute("aria-hidden","true");
  }


  // ===== helpers =====
  let compartments = [];
  const $ = (id)=>document.getElementById(id);

  const tbody = $("tbody");
  const tableWrap = $("tableWrap");
  const statusChip = $("statusChip");
  const compTotalsCard = $("compTotalsCard");
  const compBar = $("compBar");

  function setStatus(kind, text){
    statusChip.classList.remove("warn","bad");
    if(kind) statusChip.classList.add(kind);
    statusChip.textContent = text;
  }
  function safeNum(v){
    if(v===null || v===undefined) return null;
    if(v==="") return null;
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }
  function tailSuffix(){
    const t = ($("tailNo").value || "").toUpperCase().replaceAll(" ", "");
    if(!t) return "";
    // pick last 3 letters/digits
    const m = t.match(/([A-Z0-9]{3})$/);
    return m ? m[1] : "";
  }

  function updateClock(){
    const now = new Date();
    $("clockPill").textContent = "Saat: " + now.toLocaleTimeString("tr-TR", {hour:"2-digit", minute:"2-digit", second:"2-digit"});
    $("datePill").textContent = now.toLocaleDateString("tr-TR", {weekday:"long", year:"numeric", month:"2-digit", day:"2-digit"});
  }

  function calcAvgBag(){
    const totalKg = safeNum($("bagTotalKg").value);
    const pcs = safeNum($("bagPieces").value);
    if(totalKg===null || pcs===null || pcs<=0){
      $("avgBag").value = "";
      return {avg:0, ok:false};
    }
    const avg = totalKg / pcs;
    $("avgBag").value = avg.toFixed(2);
    return {avg, ok:true};
  }

  function calcFuel(){
    const totalVal = $("totalFuel").value;
    const taxiVal  = $("taxiFuel").value;
    const total = safeNum(totalVal) ?? 0;
    const taxi  = safeNum(taxiVal)  ?? 0;

    $("totalFuelEcho").textContent = (totalVal==="" ? "—" : total.toFixed(0) + " kg");
    $("taxiFuelEcho").textContent  = (taxiVal==="" ? "—" : taxi.toFixed(0) + " kg");

    if(totalVal==="" && taxiVal===""){
      $("remainFuel").textContent = "—";
      return;
    }
    $("remainFuel").textContent = (total - taxi).toFixed(0) + " kg";
  }

  function updateMetaLine(){
    const tail = ($("tailNo").value || "—").trim().toUpperCase();
    const crew = $("crewCode").value || "—";
    const ac = $("aircraft").value || "—";
    $("metaLine").value = `${tail} • ${crew} • ${ac}`;
  }

  // ===== WATER logic =====
  function a350GroupByTail(sfx){
    // from image:
    // A350 / A-C: LGA-B-C-D-E-F-G-H-M-N-O-P and LGI-J-K-L
    // A350 / B-D: LGR-S-T-U-V-Y-Z and LHA-B-C-D-E-F-G and LHH-J-I
    if(!sfx) return "A350_AC"; // default
    if(sfx.startsWith("LG")){
      const third = sfx[2];
      if("ABCDEFGHMNOP".includes(third)) return "A350_AC";
      if(["I","J","K","L"].includes(third)) return "A350_AC";
      if("RSTUVYZ".includes(third)) return "A350_BD";
    }
    if(sfx.startsWith("LH")){
      const third = sfx[2];
      if("ABCDEFG".includes(third)) return "A350_BD";
      if(["H","I","J"].includes(third)) return "A350_BD"; // covers LHH/LHI/LHJ
    }
    return "A350_AC";
  }

  function a330GroupByTail(sfx){
    if(!sfx) return "";
    // exact
    if(sfx==="JNA" || sfx==="JNB") return "A330_JNA_JNB";
    if(sfx==="JNF" || sfx==="JNG" || sfx==="JIL" || sfx==="JIM" || sfx==="JIN") return "A330_JNF_JNG_JIL_JIM_JIN";
    if(sfx==="TCL" || sfx==="LON" || sfx==="TC-LON") return "A330_TC_LON"; // safe
    if(sfx==="LON") return "A330_TC_LON";

    // grp2: JNC/JND/JNE
    if(["JNC","JND","JNE"].includes(sfx)) return "A330_GRP2";
    // grp2: JIO/JIP/JIR/JIS/JIT/JIV/JIY/JIZ
    if(sfx.startsWith("JI") && ["O","P","R","S","T","V","Y","Z"].includes(sfx[2])) return "A330_GRP2";
    // grp2: LNB/LOH/LOI/LOM
    if(["LNB","LOH","LOI","LOM"].includes(sfx)) return "A330_GRP2";

    // grp4: JNH..JNZ (third letter H-Z)
    if(sfx.startsWith("JN") && sfx[2] >= "H" && sfx[2] <= "Z") return "A330_GRP4";
    // grp4: LNC/LND/LNE/LNF/LNG
    if(["LNC","LND","LNE","LNF","LNG"].includes(sfx)) return "A330_GRP4";
    // grp4: JOA/JOB/JOC/JOD/JOE/JOF
    if(sfx.startsWith("JO") && "ABCDEF".includes(sfx[2])) return "A330_GRP4";
    // grp4: JOG/JOH/JOJ/JOI/JOK/JOL/JOM
    if(sfx.startsWith("JO") && "GHIJKLM".includes(sfx[2])) return "A330_GRP4";
    // grp4: LOA/LOB/LOC/LOD/LOE/LOF
    if(sfx.startsWith("LO") && "ABCDEF".includes(sfx[2])) return "A330_GRP4";
    // grp4: LOG/LOJ/LOK
    if(["LOG","LOJ","LOK"].includes(sfx)) return "A330_GRP4";

    return "";
  }

  function waterKeyForAircraft(ac){
    if(!ac) return "";
    if(ac==="A350"){
      return a350GroupByTail(tailSuffix());
    }
    if(ac==="A330"){
      return a330GroupByTail(tailSuffix());
    }
    return ac; // B738/B739/A319/A320/A321/B787/B777
  }

  function populateWaterOptions(){
    const ac = $("aircraft").value;
    const sfx = tailSuffix();
    const key = waterKeyForAircraft(ac);

    const sel = $("waterRatio");
    const old = sel.value;
    sel.innerHTML = `<option value="">Seçiniz</option>`;

    $("waterWeight").textContent = "—";
    $("waterIndex").textContent = "—";

    if(!ac){
      $("waterHint").textContent = "Uçak tipi seçince seçenekler gelir.";
      return;
    }

    const data = waterDB[key];
    if(!data){
      $("waterHint").textContent = "Bu uçak/tail için su tablosu bulunamadı.";
      return;
    }

    // For A350 & A330 require tail to be meaningful (still allow default for A350)
    if(ac==="A330" && !sfx){
      $("waterHint").textContent = "A330 için Tail gerekli (son 3 harf).";
    }else if(ac==="A350" && !sfx){
      $("waterHint").textContent = "A350 için Tail girersen A-C / B-D otomatik seçilir.";
    }else{
      $("waterHint").textContent = `Seçenekler hazır (${key}).`;
    }

    Object.keys(data).forEach(r=>{
      const opt = document.createElement("option");
      opt.value = r;
      opt.textContent = r;
      sel.appendChild(opt);
    });

    // keep old if exists
    if(old && data[old]) sel.value = old;
    updateWaterBox();
  }

  function updateWaterBox(){
    const ac = $("aircraft").value;
    const key = waterKeyForAircraft(ac);
    const ratio = $("waterRatio").value;
    const data = waterDB[key];
    if(!data || !ratio || !data[ratio]){
      $("waterWeight").textContent = "—";
      $("waterIndex").textContent = "—";
      return;
    }
    const w = data[ratio].w;
    const i = data[ratio].i;
    $("waterWeight").textContent = `${w} kg`;
    $("waterIndex").textContent = `${i}`;
  }

  // ===== LOAD / table =====
  function buildTable(){
    tbody.innerHTML = "";
    compartments.forEach(c=>{
      const row = document.createElement("tr");
      row.innerHTML = `
        <td class="comp">${c.name}</td>
        <td><input class="cellInput bagInput" inputmode="numeric" type="number" data-comp="${c.name}" placeholder="0"></td>
        <td class="num bagKgCell">0.0</td>
        <td><input class="cellInput cargoInput" inputmode="numeric" type="number" data-comp="${c.name}" placeholder="0"></td>
        <td class="num totalCell">0.0</td>`;
      tbody.appendChild(row);
    });

    tbody.querySelectorAll(".bagInput").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const comp = compartments.find(x=>x.name===inp.dataset.comp);
        comp.bags = inp.value==="" ? null : parseFloat(inp.value);
        updateValues();
      });
    });
    tbody.querySelectorAll(".cargoInput").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const comp = compartments.find(x=>x.name===inp.dataset.comp);
        comp.cargo = inp.value==="" ? null : parseFloat(inp.value);
        updateValues();
      });
    });
  }

  function renderCompBar(nonBulk, avg){
    compBar.innerHTML = "";
    if(!nonBulk){
      compTotalsCard.style.display = "none";
      return;
    }
    compartments.forEach(c=>{
      const bagKg = (c.bags||0) * avg;
      const total = bagKg + (c.cargo||0);
      const el = document.createElement("div");
      el.className = "stat";
      el.innerHTML = `<div class="k">Comp ${c.name}</div><div class="v">${total.toFixed(1)} kg</div>`;
      compBar.appendChild(el);
    });
    compTotalsCard.style.display = "block";
  }

  function anyBagInput(){
    return compartments.some(c => (c.bags||0) > 0);
  }

  function updateValues(){
    try{
      const ac = $("aircraft").value;
      const active = !!ac;

      const avgRes = calcAvgBag();
      const avg = avgRes.avg;

      updateMetaLine();
      calcFuel();

      // update table cells
      const compRows = tbody.querySelectorAll("tr");
      compartments.forEach((c,i)=>{
        const bagKg = (c.bags||0) * avg;
        const total = bagKg + (c.cargo||0);
        const r = compRows[i];
        if(!r) return;
        r.querySelector(".bagKgCell").textContent = bagKg.toFixed(1);
        r.querySelector(".totalCell").textContent = total.toFixed(1);
      });

      // totals
      let totalBag=0, totalCargo=0;
      compartments.forEach(c=>{
        totalBag += (c.bags||0)*avg;
        totalCargo += (c.cargo||0);
      });
      $("sumBag").textContent   = totalBag.toFixed(1);
      $("sumCargo").textContent = totalCargo.toFixed(1);
      $("sumTotal").textContent = (totalBag+totalCargo).toFixed(1);

      $("sticky").style.display = active ? "block" : "none";

      const nonBulk = active && !bulkAircraft.has(ac);
      renderCompBar(nonBulk, avg);

      // water refresh (tail/aircraft changes affect options)
      populateWaterOptions();

      // status
      if(!active){
        setStatus("", "Hazır");
      }else if(!avgRes.ok && anyBagInput()){
        setStatus("warn", "Avg eksik (Bag kg/PCS)");
      }else{
        setStatus("", "Aktif");
      }
    }catch(e){
      setStatus("bad", "Hata");
      console.error(e);
    }
  }

  function resetAll(){
    ["tailNo","crewCode","aircraft","bagTotalKg","bagPieces","avgBag","metaLine","totalFuel","taxiFuel","waterRatio"].forEach(id=>{
      const el = $(id);
      if(!el) return;
      if(el.tagName==="SELECT") el.value="";
      else el.value="";
    });

    compartments = [];
    tbody.innerHTML = "";
    tableWrap.style.display = "none";
    $("sticky").style.display = "none";
    compTotalsCard.style.display = "none";

    $("totalFuelEcho").textContent = "—";
    $("taxiFuelEcho").textContent = "—";
    $("remainFuel").textContent = "—";

    $("waterWeight").textContent = "—";
    $("waterIndex").textContent = "—";
    $("waterHint").textContent = "Uçak tipi + kuyruk girince seçenekler gelir.";
    $("waterRatio").innerHTML = `<option value="">Seçiniz</option>`;

    localStorage.removeItem("loadcalc_v7");
    setStatus("", "Hazır");
  }

  function saveLocal(){
    const payload = {
      tailNo: $("tailNo").value,
      crewCode: $("crewCode").value,
      aircraft: $("aircraft").value,
      bagTotalKg: $("bagTotalKg").value,
      bagPieces: $("bagPieces").value,
      totalFuel: $("totalFuel").value,
      taxiFuel: $("taxiFuel").value,
      waterRatio: $("waterRatio").value,
      compartments: compartments
    };
    localStorage.setItem("loadcalc_v7", JSON.stringify(payload));
    setStatus("", "Kaydedildi");
    setTimeout(()=>setStatus("", $("aircraft").value ? "Aktif" : "Hazır"), 900);
  }

  function loadLocal(){
    try{
      const raw = localStorage.getItem("loadcalc_v7");
      if(!raw) return;
      const p = JSON.parse(raw);

      $("tailNo").value = p.tailNo || "";
      $("crewCode").value = p.crewCode || "";
      $("aircraft").value = p.aircraft || "";
      $("bagTotalKg").value = p.bagTotalKg || "";
      $("bagPieces").value = p.bagPieces || "";
      $("totalFuel").value = p.totalFuel || "";
      $("taxiFuel").value = p.taxiFuel || "";

      const ac = $("aircraft").value;
      if(ac){
        // build comp list for load module (bulk types also supported)
        let loadKey = ac;
        if(ac==="B738" || ac==="B739") loadKey = "B737"; // use generic
        if(ac && aircraftComps[loadKey]){
          compartments = aircraftComps[loadKey].map(name=>{
            const found = (p.compartments||[]).find(x=>x.name===name);
            return { name, bags: found?.bags ?? null, cargo: found?.cargo ?? null };
          });
          tableWrap.style.display = "block";
          buildTable();

          // restore inputs
          tbody.querySelectorAll(".bagInput").forEach(inp=>{
            const c = compartments.find(x=>x.name===inp.dataset.comp);
            if(c && c.bags !== null) inp.value = c.bags;
          });
          tbody.querySelectorAll(".cargoInput").forEach(inp=>{
            const c = compartments.find(x=>x.name===inp.dataset.comp);
            if(c && c.cargo !== null) inp.value = c.cargo;
          });
        }else{
          compartments = [];
          tbody.innerHTML = "";
          tableWrap.style.display = "none";
        }
      }
      // water ratio restore after options
      populateWaterOptions();
      if(p.waterRatio) $("waterRatio").value = p.waterRatio;
      updateWaterBox();
    }catch(e){
      console.error(e);
    }
  }

  
  
  // Radioactive modal events
  $("radOpen").addEventListener("click", openRadModal);
  $("radClose").addEventListener("click", closeRadModal);
  $("radModalBack").addEventListener("click", (e)=>{ if(e.target && e.target.id==="radModalBack") closeRadModal(); });

  $("radAircraft").addEventListener("change", ()=>{ syncA330VariantUI(); populateRadComp(); updateRadCalc(); });
  $("a330Variant").addEventListener("change", ()=>{ $("radAircraft").value = $("a330Variant").value; syncA330VariantUI(); populateRadComp(); updateRadCalc(); });
  $("radComp").addEventListener("change", updateRadCalc);
  ["radTI","radBoxHcm"].forEach(id=>{
    $(id).addEventListener("input", updateRadCalc);
    $(id).addEventListener("change", updateRadCalc);
  });


  // events
  $("aircraft").addEventListener("change", ()=>{
    const ac = $("aircraft").value;
    tbody.innerHTML = "";
    compartments = [];

    let loadKey = ac;
    if(ac==="B738" || ac==="B739") loadKey = "B737";

    if(loadKey && aircraftComps[loadKey]){
      tableWrap.style.display = "block";
      aircraftComps[loadKey].forEach(name=>compartments.push({name, bags:null, cargo:null}));
      buildTable();
    }else{
      tableWrap.style.display = "none";
      $("sticky").style.display = "none";
      compTotalsCard.style.display = "none";
    }
    populateWaterOptions();
    updateValues();
  });

  $("tailNo").addEventListener("input", ()=>{
    // tail changes can change water table for A350/A330
    populateWaterOptions();
    updateMetaLine();
  });

  $("waterRatio").addEventListener("change", updateWaterBox);

  ["crewCode","bagTotalKg","bagPieces","totalFuel","taxiFuel"].forEach(id=>{
    $(id).addEventListener("input", updateValues);
    $(id).addEventListener("change", updateValues);
  });

  $("btnReset").addEventListener("click", resetAll);
  $("btnSave").addEventListener("click", saveLocal);

  // boot
  updateClock();
  setInterval(updateClock, 1000);
  loadLocal();
  populateWaterOptions();
  updateValues();
</script>
</body>
</html>
